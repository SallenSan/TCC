<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Admin • Sistema de Consultas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:Arial, Helvetica, sans-serif; background:#f9f6fc; margin:0; padding:20px; color:#2d2a32}
    h1{text-align:center; color:#5e4b8a}
    nav{text-align:center; margin-bottom:20px}
    nav button{margin:0 6px; padding:10px 14px; background:#c8a2c8; color:#fff; border:none; border-radius:8px; cursor:pointer}
    nav button:hover{background:#b089b0}
    .container{max-width:1200px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px}
    input, select{padding:10px; border:1px solid #d7cfe4; border-radius:8px}
    .btn{padding:10px 14px; background:#c8a2c8; color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid #eee; padding:10px; text-align:left; vertical-align:top}
    .ok{color:#1e9e63} .err{color:#c0392b}
    .card{background:#fff; border:1px solid #eee; border-radius:12px; padding:14px; margin:14px 0}
    .tools{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .tag{padding:2px 8px; border-radius:999px; background:#efe7f6; font-size:12px}
  </style>
</head>
<body>
  <h1>Admin • Sistema de Consultas</h1>
  <nav>
    <button onclick="location.href='index.html'">Sair</button>
  </nav>

  <div class="container">
    <div id="msg"></div>
    <div class="row"><b>E-mail da sessão:</b>&nbsp;<span id="emailSpan"></span></div>

    <div class="card">
      <div class="tools">
        <h2>Pacientes</h2>
        <button class="btn" id="expPac">Exportar CSV</button>
      </div>
      <form id="pacForm" class="row">
        <input id="pacNome" placeholder="Nome" required>
        <input id="pacEmail" placeholder="E-mail" type="email" required>
        <button class="btn">Salvar</button>
      </form>
      <table>
        <thead><tr><th>ID</th><th>Nome</th><th>E-mail</th><th>Ações</th></tr></thead>
        <tbody id="tbPac"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="tools">
        <h2>Psicólogos</h2>
        <button class="btn" id="expPsi">Exportar CSV</button>
      </div>
      <form id="psiForm" class="row">
        <input id="psiNome" placeholder="Nome" required>
        <input id="psiEmail" placeholder="E-mail" type="email" required>
        <input id="psiTelefone" placeholder="Telefone">
        <input id="psiCrp" placeholder="CRP">
        <input id="psiEsp" placeholder="Especialidade" required>
        <button class="btn">Salvar</button>
      </form>
      <table>
        <thead><tr><th>ID</th><th>Nome</th><th>E-mail</th><th>CRP</th><th>Tel</th><th>Esp.</th><th>Ações</th></tr></thead>
        <tbody id="tbPsi"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="tools">
        <h2>Consultas</h2>
        <button class="btn" id="expCon">Exportar CSV</button>
      </div>
      <form id="conForm" class="row">
        <select id="conPac" required><option value="">Paciente</option></select>
        <select id="conPsi" required><option value="">Psicólogo</option></select>
        <input type="datetime-local" id="conData" required>
        <select id="conStatus" required>
          <option value="PENDENTE">PENDENTE</option>
          <option value="CONFIRMADA">CONFIRMADA</option>
          <option value="CANCELADA">CANCELADA</option>
          <option value="REMARCADA">REMARCADA</option>
        </select>
        <input id="conObs" placeholder="Observações (opcional)">
        <button class="btn">Agendar</button>
      </form>
      <table>
        <thead><tr><th>ID</th><th>Data/Hora</th><th>Paciente</th><th>Psicólogo</th><th>Status</th><th>Obs</th><th>Ações</th></tr></thead>
        <tbody id="tbCon"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API='http://localhost:8080';
    const email=(localStorage.getItem('email')||'').trim().toLowerCase();
    const role=(localStorage.getItem('role')||'');
    document.getElementById('emailSpan').textContent = email || '(não definido)';
    const msg=(t,ok=true)=>{ const el=document.getElementById('msg'); el.innerHTML=`<b class="${ok?'ok':'err'}">${t}</b>`; setTimeout(()=>el.textContent='',2200); };

    // Gate de acesso: precisa estar com role 'Admin' E o e-mail existir no /usuario-admin
    (async function gate(){
      if(role!=='Admin' || !email){ alert('Acesso restrito ao Admin.'); location.href='index.html'; return; }
      try{
        const r = await fetch(API+'/usuario-admin'); if(!r.ok){ throw new Error(); }
        const arr = await r.json();
        const u = arr.find(a=> (a.email||'').toLowerCase()===email);
        if(!u){ alert('Admin não encontrado no sistema.'); location.href='index.html'; return; }
      }catch(e){
        alert('Não foi possível validar o Admin.'); location.href='index.html';
      }
    })();

    // utils
    const csv = rows => rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n');
    const download=(filename,text)=>{ const blob=new Blob([text],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); };

    // estado
    let pacientes=[], psicologos=[], consultas=[];
    async function loadAll(){
      const [rp, rpsi, rc] = await Promise.all([
        fetch(API+'/pacientes'),
        fetch(API+'/psicologos'),
        fetch(API+'/consultas')
      ]);
      pacientes=await rp.json(); psicologos=await rpsi.json(); consultas=await rc.json();
      fillPac(); fillPsi(); fillCon(); fillSelects();
    }

    // pacientes
    function fillPac(){
      const tb=document.getElementById('tbPac'); tb.innerHTML='';
      pacientes.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.id}</td><td>${p.nome}</td><td>${p.email||''}</td>
        <td>
          <button class="btn" data-e="${p.id}">Editar</button>
          <button class="btn" data-d="${p.id}" style="background:#c0392b">Excluir</button>
        </td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('[data-e]').forEach(b=> b.onclick=()=>{
        const id=+b.dataset.e; const p=pacientes.find(x=>x.id===id);
        const nome=prompt('Nome:', p.nome); if(nome===null) return;
        const email=prompt('E-mail:', p.email||''); if(email===null) return;
        fetch(`${API}/pacientes/${id}`,{method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...p, nome, email})})
          .then(r=>r.ok?(msg('Paciente atualizado'), loadAll()):msg('Falha ao atualizar', false));
      });
      tb.querySelectorAll('[data-d]').forEach(b=> b.onclick=()=>{
        const id=+b.dataset.d; if(!confirm('Excluir paciente?')) return;
        fetch(`${API}/pacientes/${id}`,{method:'DELETE'}).then(r=>r.ok?(msg('Excluído'), loadAll()):msg('Falha ao excluir', false));
      });
    }
    document.getElementById('pacForm').addEventListener('submit', e=>{
      e.preventDefault();
      const nome=document.getElementById('pacNome').value.trim();
      const email=document.getElementById('pacEmail').value.trim();
      if(!nome||!email.includes('@')){ msg('Dados inválidos', false); return; }
      fetch(API+'/pacientes',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nome,email})})
        .then(r=>r.ok?(msg('Cadastrado'), e.target.reset(), loadAll()):msg('Erro ao cadastrar', false));
    });
    document.getElementById('expPac').onclick=()=>download('pacientes.csv', csv([['ID','Nome','Email'], ...pacientes.map(p=>[p.id,p.nome,p.email||''])]));

    // psicologos
    function fillPsi(){
      const tb=document.getElementById('tbPsi'); tb.innerHTML='';
      psicologos.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.id}</td><td>${p.nome}</td><td>${p.email||''}</td><td>${p.crp||''}</td><td>${p.telefone||''}</td><td>${p.especialidade||''}</td>
        <td>
          <button class="btn" data-e="${p.id}">Editar</button>
          <button class="btn" data-d="${p.id}" style="background:#c0392b">Excluir</button>
        </td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('[data-e]').forEach(b=> b.onclick=()=>{
        const id=+b.dataset.e; const p=psicologos.find(x=>x.id===id);
        const nome=prompt('Nome:', p.nome); if(nome===null) return;
        const email=prompt('E-mail:', p.email||''); if(email===null) return;
        const telefone=prompt('Telefone:', p.telefone||''); if(telefone===null) return;
        const crp=prompt('CRP:', p.crp||''); if(crp===null) return;
        const especialidade=prompt('Especialidade:', p.especialidade||''); if(especialidade===null) return;
        fetch(`${API}/psicologos/${id}`,{method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...p, nome, email, telefone, crp, especialidade})})
          .then(r=>r.ok?(msg('Psicólogo atualizado'), loadAll()):msg('Falha ao atualizar', false));
      });
      tb.querySelectorAll('[data-d]').forEach(b=> b.onclick=()=>{
        const id=+b.dataset.d; if(!confirm('Excluir psicólogo?')) return;
        fetch(`${API}/psicologos/${id}`,{method:'DELETE'}).then(r=>r.ok?(msg('Excluído'), loadAll()):msg('Falha ao excluir', false));
      });
    }
    document.getElementById('psiForm').addEventListener('submit', e=>{
      e.preventDefault();
      const payload={
        nome:document.getElementById('psiNome').value.trim(),
        email:document.getElementById('psiEmail').value.trim(),
        telefone:document.getElementById('psiTelefone').value.trim(),
        crp:document.getElementById('psiCrp').value.trim(),
        especialidade:document.getElementById('psiEsp').value.trim()
      };
      if(!payload.nome || !payload.email.includes('@') || !payload.especialidade){ msg('Preencha nome, e-mail e especialidade', false); return; }
      fetch(API+'/psicologos',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
        .then(r=>r.ok?(msg('Cadastrado'), e.target.reset(), loadAll()):msg('Erro ao cadastrar', false));
    });
    document.getElementById('expPsi').onclick=()=>download('psicologos.csv', csv([['ID','Nome','Email','CRP','Telefone','Especialidade'], ...psicologos.map(p=>[p.id,p.nome,p.email||'',p.crp||'',p.telefone||'',p.especialidade||''])]));

    // consultas
    function fillSelects(){
      const conPac=document.getElementById('conPac');
      const conPsi=document.getElementById('conPsi');
      conPac.innerHTML='<option value="">Paciente</option>'+pacientes.map(p=>`<option value="${p.id}">${p.nome} (${p.email})</option>`).join('');
      conPsi.innerHTML='<option value="">Psicólogo</option>'+psicologos.map(p=>`<option value="${p.id}">${p.nome} • ${p.email||''}</option>`).join('');
    }
    function fillCon(){
      const tb=document.getElementById('tbCon'); tb.innerHTML='';
      consultas.sort((a,b)=> new Date(a.dataHora)-new Date(b.dataHora))
      .forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.id}</td>
        <td>${c.dataHora ? new Date(c.dataHora).toLocaleString('pt-BR') : '-'}</td>
        <td>${c.paciente?.nome||('ID '+c.paciente?.id)}</td>
        <td>${c.psicologo?.nome||('ID '+c.psicologo?.id)}</td>
        <td><span class="tag">${c.status}</span></td>
        <td>${c.observacoes||''}</td>
        <td>
          <button class="btn" data-e="${c.id}">Editar</button>
          <button class="btn" data-d="${c.id}" style="background:#c0392b">Excluir</button>
        </td>`;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('[data-e]').forEach(b=> b.onclick=()=>{
        const id=+b.dataset.e; const c=consultas.find(x=>x.id===id);
        const data = prompt('Data/hora (AAAA-MM-DDTHH:MM):', c.dataHora? c.dataHora.slice(0,16).replace('Z',''):''); if(data===null) return;
        const status = prompt('Status (PENDENTE/CONFIRMADA/CANCELADA/REMARCADA):', c.status||'PENDENTE'); if(status===null) return;
        const obs = prompt('Observações:', c.observacoes||''); if(obs===null) return;
        fetch(`${API}/consultas/${id}`,{
          method:'PUT', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({...c, dataHora:data? new Date(data).toISOString():c.dataHora, status, observacoes:obs})
        }).then(r=>r.ok?(msg('Consulta atualizada'), loadAll()):msg('Falha ao atualizar', false));
      });
      tb.querySelectorAll('[data-d]').forEach(b=> b.onclick=()=>{
        const id=+b.dataset.d; if(!confirm('Excluir consulta?')) return;
        fetch(`${API}/consultas/${id}`,{method:'DELETE'}).then(r=>r.ok?(msg('Excluída'), loadAll()):msg('Falha ao excluir', false));
      });
    }
    document.getElementById('conForm').addEventListener('submit', e=>{
      e.preventDefault();
      const pid=+document.getElementById('conPac').value;
      const psid=+document.getElementById('conPsi').value;
      const data=document.getElementById('conData').value;
      const status=document.getElementById('conStatus').value;
      const obs=document.getElementById('conObs').value.trim();
      if(!pid||!psid||!data){ msg('Preencha paciente, psicólogo e data/hora', false); return; }
      const payload={paciente:{id:pid}, psicologo:{id:psid}, dataHora:new Date(data).toISOString(), status, observacoes: obs||null};
      fetch(API+'/consultas',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
        .then(r=>r.ok?(msg('Consulta agendada'), e.target.reset(), loadAll()):msg('Erro ao agendar', false));
    });
    document.getElementById('expCon').onclick=()=>download('consultas.csv', csv([['ID','DataHora','Paciente','Psicologo','Status','Obs'], ...consultas.map(c=>[c.id,c.dataHora,c.paciente?.nome||c.paciente?.id||'',c.psicologo?.nome||c.psicologo?.id||'',c.status,c.observacoes||''])]));

    (async function start(){ await loadAll(); })();
  </script>
</body>
</html>
